services:
  nginx:
    image: nginx:alpine
    ports:
      - "${BIND_IP:-0.0.0.0}:443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - mem0
    restart: unless-stopped

  litellm:
    image: ghcr.io/berriai/litellm:main-stable
    volumes:
      - ./litellm-config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    env_file:
      - .env
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-sidstack-dev}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/readiness')"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  mem0:
    image: ghcr.io/chuongld20/mem0:main
    depends_on:
      litellm:
        condition: service_healthy
    environment:
      - MEM0_API_KEY=${MEM0_API_KEY:-}
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-sidstack_mem0}
      - LITELLM_BASE_URL=http://litellm:4000/v1
      - LITELLM_API_BASE=http://litellm:4000/v1
      - OPENAI_BASE_URL=http://litellm:4000/v1
      - LITELLM_API_KEY=${LITELLM_MASTER_KEY:-sk-sidstack-dev}
      - LLM_MODEL=${LLM_MODEL:-gemini-flash}
      - EMBED_MODEL=${EMBED_MODEL:-gemini-embedding}
    env_file:
      - .env
    restart: unless-stopped
